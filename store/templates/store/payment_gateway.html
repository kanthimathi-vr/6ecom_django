{% extends 'base.html' %}
{% load static %}

{% block content %}

<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-md-7 text-center">
            
            <div class="card shadow-lg p-4">
                <div class="card-body">
                    <h1 class="fw-bold text-primary mb-4">Processing Payment...</h1>
                    
                    <p class="lead">
                        You are paying for Order #{{ order.id }}.
                    </p>
                    <h2 class="display-6 fw-bold mb-4">
                        Total: â‚¹{{ order.get_total_with_shipping|floatformat:2 }}
                    </h2>
                    
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    
                    <p class="mt-3 text-muted">Please wait while we connect to the secure payment gateway. If the modal does not appear, click the button below.</p>
                    
                    {# This button is hidden but serves as a fallback #}
                    <button id="rzp-button" class="btn btn-success btn-lg mt-3" style="display:none;">
                        Click to Pay Now
                    </button>
                </div>
            </div>
            
        </div>
    </div>
</div>

{# --- RAZORPAY JAVASCRIPT INTEGRATION --- #}
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
    // Ensure these context variables are passed from your Django view:
    // 1. razorpay_order_id (The ID created by the Razorpay API call in your view)
    // 2. amount (The total amount in smallest currency unit, e.g., paise/cents)
    // 3. key_id (Your public Razorpay Key ID)
    // 4. customer_name
    // 5. customer_email
    
    // Placeholder Django template variables (replace with actual context data)
    var RAZORPAY_ORDER_ID = "{{ razorpay_order_id }}";
    var AMOUNT_DUE = "{{ amount }}"; 
    var KEY_ID = "{{ key_id }}";
    var NAME = "{{ customer_name }}";
    var EMAIL = "{{ customer_email }}";
    var DESCRIPTION = "Order Payment #{{ order.id }}";
    
    var options = {
        "key": KEY_ID, 
        "amount": AMOUNT_DUE, // The amount in paise
        "currency": "INR",
        "name": "Your Store Name",
        "description": DESCRIPTION,
        "order_id": RAZORPAY_ORDER_ID, 
        "handler": function (response){
            // This function runs upon successful payment
            
            // Send the response data (payment_id, order_id, signature) back to your Django view
            window.location.href = "{% url 'store:payment_success' %}?razorpay_payment_id=" + response.razorpay_payment_id + 
                                   "&razorpay_order_id=" + response.razorpay_order_id +
                                   "&razorpay_signature=" + response.razorpay_signature;
        },
        "prefill": {
            "name": NAME,
            "email": EMAIL,
        },
        "theme": {
            "color": "#0D6EFD" // Bootstrap primary color
        }
    };
    
    var rzp1 = new Razorpay(options);

    document.getElementById('rzp-button').onclick = function(e){
        rzp1.open();
        e.preventDefault();
    }

    // Automatically open the modal when the page loads
    window.onload = function() {
        rzp1.open();
    };
</script>

{% endblock content %}